@{
    ViewBag.Title = "Inicio";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var nombreUsuario = Context.Session.GetString("NombreUsuario");
}

<section class="hero">
    @if (!string.IsNullOrEmpty(nombreUsuario))
    {
        <div class="saludo-container">
            <p class="bienvenida">¡Hola, @nombreUsuario!</p>
        </div>
    }

    <h1 id="titulo-dinamico" class="title" style="min-height: 2.5rem;">¿</h1>
    <p class="subtitle">Subí tu material y prepará el examen.</p>

    <div class="upload">
        <div class="upload-box" id="dropArea">
            <p>Haz clic para subir, o arrastra los PDF aquí</p>

            <!-- Lista de archivos seleccionados -->
            <ul id="fileList" style="list-style:none; padding-left:0; margin-top:1rem;"></ul>

            <form enctype="multipart/form-data" method="post" action="/Home/SubirPdf" id="uploadForm">
                <label class="upload-btn">
                    <input type="file" accept="application/pdf" multiple hidden id="fileInput" />
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 24 24">
                            <path fill="#FFFFFF" d="M6 20q-.825 0-1.412-.587T4 18v-2q0-.425.288-.712T5 15t.713.288T6 16v2h12v-2q0-.425.288-.712T19 15t.713.288T20 16v2q0 .825-.587 1.413T18 20zm5-12.15L9.125 9.725q-.3.3-.712.288T7.7 9.7q-.275-.3-.288-.7t.288-.7l3.6-3.6q.15-.15.325-.212T12 4.425t.375.063t.325.212l3.6 3.6q.3.3.288.7t-.288.7q-.3.3-.712.313t-.713-.288L13 7.85V15q0 .425-.288.713T12 16t-.712-.288T11 15z" />
                        </svg>
                        Subir PDFs
                    </span>
                </label>

                <input type="submit" value="Crear examen" class="upload-btn crear-examen"
                       id="crearExamenBtn" style="display:none;" />
            </form>
        </div>
    </div>

    <div id="examResult" style="margin-top:2rem;"></div>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="downloadPdfServerBtn" class="upload-btn" style="display:none; margin-top:1rem;">Descargar PDF</button>
    </div>

    <!-- Loader overlay -->
    <div id="examOverlay" style="display:none;">
        <div class="spinner-box">
            <div class="spinner"></div>
            <div class="loader-text">Generando examen...</div>
        </div>
    </div>
</section>

<script>
    const dropArea      = document.getElementById('dropArea');
    const fileInput     = document.getElementById('fileInput');
    const fileList      = document.getElementById('fileList');
    const crearExamenBtn= document.getElementById('crearExamenBtn');
    const uploadForm    = document.getElementById('uploadForm');
    const examResult    = document.getElementById('examResult');
    const examOverlay   = document.getElementById('examOverlay');
    const downloadPdfServerBtn= document.getElementById('downloadPdfServerBtn');

    // Mantener último examen generado para poder enviarlo al servidor
    let lastExam = null;

    // Loader styles (inyectados una sola vez)
    if(!document.getElementById('loaderStyles')){
        const style = document.createElement('style');
        style.id = 'loaderStyles';
        style.textContent = `
        #examOverlay{
            position:fixed; inset:0; z-index:1000;
            display:flex; align-items:center; justify-content:center;
            background:rgba(0,0,0,.45); backdrop-filter: blur(2px);
        }
        #examOverlay .spinner-box{ display:flex; flex-direction:column; align-items:center; gap:12px; }
        #examOverlay .spinner{
            width:56px; height:56px; border-radius:50%;
            border:5px solid rgba(255,255,255,.18);
            border-top-color:#9aa7ff;
            animation:spin 1s linear infinite;
        }
        #examOverlay .loader-text{ color:#e6e9ff; font-weight:600; letter-spacing:.2px }
        @@keyframes spin{ to{ transform:rotate(360deg) } }
        `;
        document.head.appendChild(style);
    }

    function setLoading(isLoading){
        examOverlay.style.display = isLoading ? 'flex' : 'none';
        crearExamenBtn.disabled = !!isLoading;
    }

    // arreglo para mantener los archivos seleccionados
    let selectedFiles = [];

    // Drag & Drop - prevenir comportamiento por defecto
    ['dragenter','dragover','dragleave','drop'].forEach(ev =>
        dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); })
    );

    // Efecto visual en drag
    ['dragenter','dragover'].forEach(ev =>
        dropArea.addEventListener(ev, () => dropArea.style.boxShadow = "0 0 20px #4dabf7")
    );
    ['dragleave','drop'].forEach(ev =>
        dropArea.addEventListener(ev, () => dropArea.style.boxShadow = "")
    );

    // Verificar si el usuario está logueado
    function isUserLoggedIn() {
        return document.body.dataset.loggedIn === "true";
    }

    // Mostrar popup de login si no está autenticado
    function showLoginPopup() {
        const authPopup = document.getElementById('authPopup');
        const overlay = document.getElementById('overlay');
        if (authPopup && overlay) {
            authPopup.classList.add('show');
            overlay.classList.add('show');
        }
    }

    // Interceptar click en el label del input
    document.querySelector('.upload-btn').addEventListener('click', e => {
        if (!isUserLoggedIn()) {
            e.preventDefault();
            showLoginPopup();
            alert('Por favor, inicia sesión para subir archivos PDF');
        }
    });

    // Interceptar el drop
    dropArea.addEventListener('drop', e => {
        if (!isUserLoggedIn()) {
            e.preventDefault();
            showLoginPopup();
            alert('Por favor, inicia sesión para subir archivos PDF');
            return;
        }
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (file.type === "application/pdf") {
                selectedFiles.push(file);
                addFileToList(file);
            }
        });
        updateSubmitVisibility();
        fileInput.value = '';
    }

    function addFileToList(file) {
        const li = document.createElement('li');
        li.style.marginBottom = "6px";
        li.style.fontFamily   = "'Istok Web', sans-serif";
        li.style.fontSize     = "0.95rem";
        li.style.display      = "flex";
        li.style.alignItems   = "center";
        li.style.justifyContent = "space-between";
         li.style.width            = "300px";
         li.style.margin = "0 auto";

        const nameSpan = document.createElement('span');
        nameSpan.textContent = file.name;

        const removeBtn = document.createElement('button');
        removeBtn.textContent = '✕';
        removeBtn.type = 'button';
        removeBtn.style.marginLeft = '10px';
        removeBtn.style.background = 'transparent';
        removeBtn.style.border = 'none';
        removeBtn.style.color = 'grey';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.fontSize = '1rem';

        removeBtn.addEventListener('click', () => {
            // quitar del arreglo
            selectedFiles = selectedFiles.filter(f => f !== file);
            // quitar del DOM
            li.remove();
            updateSubmitVisibility();
        });

        li.appendChild(nameSpan);
        li.appendChild(removeBtn);
        fileList.appendChild(li);
    }

    function updateSubmitVisibility() {
        crearExamenBtn.style.display = selectedFiles.length > 0 ? 'inline-block' : 'none';
    }

    // Enviar con archivos en memoria
    uploadForm.addEventListener('submit', e => {
        e.preventDefault();
        if (selectedFiles.length === 0) return;

        const formData = new FormData();
        selectedFiles.forEach(f => formData.append('archivoPdf', f));

        setLoading(true);
        fetch('/Exam/Generate', { method: 'POST', body: formData })
            .then(async res => {
                if(!res.ok){
                    const txt = await res.text();
                    throw new Error(txt || 'Error al procesar PDFs');
                }
                return res.json();
            })
            .then(data => {
                if(!data.success){ alert(data.mensaje || 'No se pudo generar el examen'); return; }
                renderExam(data.exam);
                examResult.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(err => {
                console.error(err);
                alert('Error: ' + err.message);
            })
            .finally(() => setLoading(false));
    });

       function renderExam(exam) {
        if (!exam || !Array.isArray(exam.questions)) {
            examResult.innerHTML = '<p>No se recibieron preguntas.</p>';
            return;
        }
        lastExam = exam;

        // Inyectar estilos una sola vez
        if (!document.getElementById('examStyles')) {
            const style = document.createElement('style');
            style.id = 'examStyles';
            style.textContent = `
            #examResult { max-width:960px; margin:2rem auto; text-align:left; }
            .exam-title { color:#e6e9ff; margin-bottom:.5rem }
            .exam-summary { color:#cfd3ff; margin-bottom:1rem }
            .exam-question { background:rgba(255,255,255,.035); border:1px solid rgba(255,255,255,.08);
                             border-radius:12px; padding:16px; margin:12px 0 }
            .exam-question h3 { color:#e6e9ff; margin:0 0 .5rem; font-size:1.05rem }
            .exam-options { list-style:none; margin:0; padding:0 }
            .exam-options li { display:flex; gap:10px; align-items:flex-start; padding:8px; border-radius:8px;
                               color:#e6e9ff; cursor:pointer; transition:background .3s, transform .2s }
            .exam-options li:hover { background:rgba(255,255,255,.06); transform:scale(1.01) }
            .exam-options li.correct { background:rgba(60,199,95,.14); border:1px solid rgba(74,222,128,.25); }
            .exam-options li.incorrect { background:rgba(255,99,99,.14); border:1px solid rgba(255,99,99,.25); }
            .exam-letter { font-weight:700; color:#cfd3ff; min-width:18px }
            .exam-explain { margin-top:.5rem; color:#b8befa }
            .progress-bar-container { width:100%; background:rgba(255,255,255,.1); height:10px;
                                      border-radius:10px; margin:20px 0; overflow:hidden; }
            .progress-bar { height:100%; width:0%; background:#4dabf7; transition:width 0.4s ease; }
            `;
            document.head.appendChild(style);
        }

        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
        const blocks = [];
        blocks.push(`<h2 class="exam-title">Examen generado</h2>`);
        if (exam.sourceSummary) {
            blocks.push(`<div class="exam-summary">Resumen: ${escapeHtml(exam.sourceSummary)}</div>`);
        }

        // Barra de progreso
            blocks.push(`
      <div id="progress-wrapper">
        <div class="progress-bar-container"><div class="progress-bar" id="examProgress"></div></div>
      </div>
    `);

        exam.questions.forEach((q, idx) => {
            const opts = (q.options || []).map((opt, i) => {
                return `<li data-q="${idx}" data-i="${i}">
                            <span class="exam-letter">${letters[i] || ''}.</span>
                            <span>${escapeHtml(opt || '')}</span>
                        </li>`;
            }).join('');

            const explain = q.explanation
                ? `<details class="exam-explain"><summary>Explicación</summary><p>${escapeHtml(q.explanation)}</p></details>`
                : '';

            blocks.push(`
                <div class="exam-question" data-index="${idx}">
                    <h3>${idx + 1}. ${escapeHtml(q.question || '')}</h3>
                    <ul class="exam-options">${opts}</ul>
                    ${explain}
                </div>
            `);
        });

        examResult.innerHTML = blocks.join('');
        downloadPdfServerBtn.style.display = 'inline-block';

              const progressWrapper = document.getElementById('progress-wrapper');
    if (progressWrapper) {
        const fixedClass = 'fixed-wrapper';
        const wrapperParent = progressWrapper.parentElement;

        // Guardar valores iniciales
        const offsetTop = progressWrapper.offsetTop;
        const wrapperHeight = progressWrapper.offsetHeight;
        let wrapperWidth = progressWrapper.offsetWidth;
        let wrapperLeft = progressWrapper.getBoundingClientRect().left + window.scrollX;

        let ticking = false;

        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    const scrollY = window.scrollY;

                    if (scrollY > offsetTop) {
                        if (!progressWrapper.classList.contains(fixedClass)) {
                            progressWrapper.classList.add(fixedClass);
                            progressWrapper.style.width = wrapperWidth + 'px';
                            progressWrapper.style.left = wrapperLeft + 'px';
                            wrapperParent.style.paddingTop = wrapperHeight + 'px';
                        }
                    } else {
                        if (progressWrapper.classList.contains(fixedClass)) {
                            progressWrapper.classList.remove(fixedClass);
                            progressWrapper.style.width = '';
                            progressWrapper.style.left = '';
                            wrapperParent.style.paddingTop = '0';
                        }
                    }

                    ticking = false;
                });
                ticking = true;
            }
        });

        // Recalcular ancho/left si cambió el tamaño de ventana
        window.addEventListener('resize', () => {
            wrapperWidth = progressWrapper.offsetWidth;
            wrapperLeft = progressWrapper.getBoundingClientRect().left + window.scrollX;
        });
    }


        // Interacción y progreso
    const questions = document.querySelectorAll('.exam-question');
    const progressBar = document.getElementById('examProgress');
    let answered = 0;

    // Inicialmente deshabilitar el botón de descargar
    downloadPdfServerBtn.style.display = 'none';

    questions.forEach(qEl => {
        const qIndex = parseInt(qEl.dataset.index);
        const correctIndex = exam.questions[qIndex].correctIndex;
        const opts = qEl.querySelectorAll('li');

        opts.forEach(opt => {
            opt.addEventListener('click', () => {
                if (qEl.classList.contains('answered')) return;
                qEl.classList.add('answered');

                const selected = parseInt(opt.dataset.i);
                const explain = qEl.querySelector('.exam-explain');

                if (selected === correctIndex) {
                    opt.classList.add('correct');
                } else {
                    opt.classList.add('incorrect');
                    opts[correctIndex].classList.add('correct');
                }

                // Mostrar explicación solo después de responder
                if (explain) explain.style.display = 'block';

                answered++;
                const progress = (answered / exam.questions.length) * 100;
                progressBar.style.width = progress + '%';

                // Habilitar botón de descargar si todas las preguntas fueron respondidas
                if (answered === exam.questions.length) {
                    downloadPdfServerBtn.style.display = 'inline-block';
                }
            });
        });
    });


      
    }


    function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    // Descargar PDF desde el servidor con QuestPDF
    downloadPdfServerBtn?.addEventListener('click', async () => {
        if(!lastExam){ alert('Primero genera un examen.'); return; }
        setLoading(true);
        try{
            const res = await fetch('/Pdf/Download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lastExam)
            });
            if(!res.ok){
                const txt = await res.text();
                throw new Error(txt || 'No se pudo generar el PDF en el servidor');
            }
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Examen.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }catch(err){
            console.error(err);
            alert('Error al generar PDF: ' + err.message);
        }finally{
            setLoading(false);
        }
    });
</script>


<script>
    const frases = [
        "QUÉ ESTUDIAMOS HOY?",
        "LISTO PARA REPASAR?",
        "QUÉ TEMA TOCA AHORA?",
        "HACEMOS UN EXAMEN RÁPIDO?"
    ];

    let indiceFrase = 0;
    let indiceLetra = 0;
    const velocidadEscritura = 100;
    const velocidadCambio = 4000;
    const h1 = document.getElementById("titulo-dinamico");

    function escribir() {
        const frase = frases[indiceFrase];
        h1.textContent = "¿" + frase.slice(0, indiceLetra);
        indiceLetra++;

        if (indiceLetra <= frase.length) {
             setTimeout(escribir, velocidadEscritura);
        } else {
                setTimeout(borrar, velocidadCambio);
        }
    }

    function borrar() {
       const frase = frases[indiceFrase];
       h1.textContent = "¿" + frase.slice(0, indiceLetra);
       indiceLetra--;

       if (indiceLetra >= 0) {
          setTimeout(borrar, 100);
       } else {
          h1.innerHTML = "¿";
          indiceFrase = (indiceFrase + 1) % frases.length;
          indiceLetra = 0;
          setTimeout(escribir, 200);
        }
    }

    escribir();


</script>

